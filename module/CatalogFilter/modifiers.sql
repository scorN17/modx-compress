-- phpMyAdmin SQL Dump
-- version 4.0.10.19
-- https://www.phpmyadmin.net
--
-- Хост: 10.0.0.161:3308
-- Время создания: Июн 15 2017 г., 14:19
-- Версия сервера: 5.5.44-37.3-log
-- Версия PHP: 5.3.3

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
SET time_zone = "+00:00";

--
-- База данных: `alfa-ltd-ru_sigma`
--

-- --------------------------------------------------------

--
-- Структура таблицы `dots_modifiers`
--

CREATE TABLE IF NOT EXISTS `dots_modifiers` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(63) NOT NULL,
  `file` varchar(255) NOT NULL,
  `type` set('before','replace','after') NOT NULL DEFAULT 'replace',
  `position` varchar(15) NOT NULL,
  `search` text NOT NULL,
  `code` text NOT NULL,
  `result` set('y','n') NOT NULL DEFAULT 'n',
  `tm` bigint(20) NOT NULL,
  `i` int(11) NOT NULL,
  `e` set('y','n') NOT NULL DEFAULT 'y',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=8 ;

--
-- Дамп данных таблицы `dots_modifiers`
--

INSERT INTO `dots_modifiers` (`id`, `name`, `file`, `type`, `position`, `search`, `code`, `result`, `tm`, `i`, `e`) VALUES
(1, 'Catalog Filter', 'manager/includes/document.parser.class.inc.php', 'after', '', 'var $documentIdentifier;', '\r\n	\r\n	var $urlXParams; //scorn\r\n	', 'y', 1495109111, 1, 'y'),
(2, 'Catalog Filter', 'manager/includes/document.parser.class.inc.php', 'before', '', '    function checkSQLconnect($connector = ''db''){', '\r\n\r\n//============================================================================================================\r\n	//scorn\r\n	function urlXParams($url)\r\n	{\r\n		$url_without_params= $url;\r\n		preg_match("/(.*)\\/(x\\/(.*)\\/)$/", $url_without_params, $matches);\r\n		$x_params= $matches[3];\r\n		$url_without_params= str_replace($matches[2], '''', $url_without_params);\r\n		return array($url, $url_without_params, $x_params);\r\n	}\r\n//============================================================================================================\r\n\r\n', 'y', 1495109111, 2, 'y'),
(3, 'Catalog Filter', 'manager/includes/document.parser.class.inc.php', 'after', '', 'function sendStrictURI(){', '\r\n\r\n			if($this->urlXParams) return; //scorn\r\n\r\n', 'y', 1495109111, 3, 'y'),
(4, 'Catalog Filter', 'manager/includes/document.parser.class.inc.php', 'after', '', '$this->documentIdentifier= $this->getDocumentIdentifier($this->documentMethod);', '\r\n\r\n\r\n            $foo= $this->urlXParams($this->documentIdentifier); //scorn\r\n            $this->documentIdentifier= $foo[1]; //scorn\r\n            $this->urlXParams= $foo[2]; //scorn\r\n', 'y', 1495109111, 4, 'y'),
(5, 'Catalog Filter', 'manager/actions/mutate_content.dynamic.php', 'after', '', '</div><!-- end .sectionBody -->\n<?php } ?>', '\r\n\r\n\r\n\r\n<?php\r\n//scorN\r\nif(($content[''type''] == ''document'' || $_REQUEST[''a'']==''4'') || ($content[''type'']==''reference'' || $_REQUEST[''a'']==72)){?>\r\n		<div class="sectionHeader" id="tv_header"><?php echo $_lang[''settings_templvars'']?></div>\r\n			<div class="sectionBody tmplvars_dop" id="tv_body">\r\n<?php\r\n	$parentslist= $modx->runSnippet(''GetIdOnLvl'',array(''id''=>($id?$id:$pid), ''koren''=>0));\r\n	if(is_array($parentslist) && count($parentslist))\r\n	{\r\n		foreach($parentslist AS $row)\r\n			if($row[''id'']) $qq .= (!empty($qq) ? " OR " : "") ."folders LIKE ''%,{$row[id]},%''";\r\n	}\r\n	if($qq) $rs= $modx->db->query("SELECT * FROM ".$modx->getFullTableName(''_catfilter'')." WHERE ({$qq}) AND type!=''price'' AND e=''y'' ORDER BY i");\r\n	if($rs && $modx->db->getRecordCount($rs))\r\n	{\r\n		print ''<table style="position:relative;" border="0" cellspacing="0" cellpadding="3" width="100%">'';\r\n		while($row= $modx->db->getRow($rs))\r\n		{\r\n			$rr= $modx->db->query("SELECT id, `value`, dop FROM ".$modx->getFullTableName(''_catfilter_value'')." WHERE cf_id={$row[id]} GROUP BY `value`");\r\n			if($rr && $modx->db->getRecordCount($rr))\r\n			{\r\n				while($val= $modx->db->getRow($rr))\r\n				{\r\n					if($val[''value''])\r\n						$props[$row[''id'']][$val[''id'']]= array($val[''value''], $val[''dop'']);\r\n				}\r\n			}\r\n			\r\n			print ''<tr style="height: 24px;">\r\n					<td align="left" valign="top" width="150">\r\n						<span class="warning">''. $row[ ''name'' ] .'', ''. $row[ ''ed'' ] .''</span>\r\n					</td>\r\n					<td valign="top" style="position:relative;">\r\n						<div style="padding:5px 0px 5px 0px;">'';\r\n						\r\n			$rs2= $modx->db->query("SELECT id, `value`, dop FROM ".$modx->getFullTableName(''_catfilter_value'')."\r\n				WHERE cf_id={$row[id]} AND itemid=''{$id}'' ORDER BY id");\r\n			if($rs2 && $modx->db->getRecordCount($rs2))\r\n			{\r\n				while($row2= $modx->db->getRow($rs2))\r\n				{\r\n					print ''<div style="padding:0px 0px 2px 0px;">'';\r\n					print ''<input type="text" id="doptv''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''_tx" name="doptv''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''_tx" value="''. $row2[ ''value'' ] .''" tvtype="text" onchange="documentDirty=true;" style="width:200px;" />'';\r\n					print ''<input type="text" id="doptv''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''_tx2" name="doptv''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''_tx2" value="''. $row2[ ''dop'' ] .''" tvtype="text" onchange="documentDirty=true;" style="width:200px;" />'';\r\n					\r\n					print ''<select class="doptv_select_val" data-id="''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''">'';\r\n					if(is_array($props[$row[''id'']]) && count($props[$row[''id'']]))\r\n					{\r\n						print ''<option data-val1="-">~ выберите ~</option>'';\r\n						foreach($props[$row[''id''] ] AS $val)\r\n						{\r\n							print ''<option value="''. $val[ 0 ] .''||''. $val[ 1 ] .''">''. $val[ 0 ] .''</option>'';\r\n						}\r\n					}\r\n					print ''</select>'';\r\n					\r\n					if($row[''type'']==''values'') print ''<input type="checkbox" id="doptv_''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''" name="doptv''. $row[ ''id'' ] .''_''. $row2[ ''id'' ] .''_del" value="del" tvtype="checkbox" onchange="documentDirty=true;" />- удалить'';\r\n					\r\n					print ''</div>'';\r\n				}\r\n			}\r\n\r\n			if( ! $modx->db->getRecordCount($rs2) || $row[''type''] == ''values'')\r\n			{\r\n				for($kk=1; $kk<=($row[''type'']==''values'' ? 5 : 1); $kk++)\r\n				{\r\n					print ''<div style="padding:0px 0px 2px 0px;">'';\r\n					print ''<input type="text" id="doptv''. $row[ ''id'' ] .''_x''. $kk .''_tx" name="doptv''. $row[ ''id'' ] .''_x''. $kk .''_tx" value="''. $row2[ ''value'' ] .''" tvtype="text" onchange="documentDirty=true;" style="width:200px;" />'';\r\n					print ''<input type="text" id="doptv''. $row[ ''id'' ] .''_x''. $kk .''_tx2" name="doptv''. $row[ ''id'' ] .''_x''. $kk .''_tx2" value="''. $row2[ ''dop'' ] .''" tvtype="text" onchange="documentDirty=true;" style="width:200px;" />'';\r\n					\r\n						print ''<select class="doptv_select_val" data-id="''. $row[ ''id'' ] .''_x''. $kk .''">'';\r\n						if(is_array($props[$row[''id'']]) && count($props[$row[''id'']]))\r\n						{\r\n							print ''<option data-val1="-">~ выберите ~</option>'';\r\n							foreach($props[$row[''id''] ] AS $val)\r\n							{\r\n								print ''<option value="''. $val[ 0 ] .''||''. $val[ 1 ] .''">''. $val[ 0 ] .''</option>'';\r\n							}\r\n						}\r\n						print ''</select>'';\r\n					\r\n					print ''</div>'';\r\n				}\r\n			}\r\n			\r\n			print ''</div>\r\n					</td>\r\n				</tr>\r\n				<tr><td colspan="2"><div class="split"></div></td></tr>'';\r\n		}\r\n		print ''</table>'';\r\n	}\r\n?>\r\n			</div>\r\n<script type="text/javascript" src="//yastatic.net/jquery/2.1.4/jquery.min.js"></script>\r\n<script type="text/javascript" src="//yastatic.net/jquery-ui/1.11.2/jquery-ui.min.js"></script>\r\n<script type="text/javascript">\r\n/* <![CDATA[ */\r\n	var $v= jQuery.noConflict();\r\n	$v( ''.doptv_select_val'' ).change(function(){\r\n		var val= $v( this ).val();\r\n		if( val != ''-'' )\r\n		{\r\n			var id= $v( this ).data( ''id'' );\r\n			val= val.split( "||" );\r\n			$v( ''#doptv''+ id +''_tx'' ).val( val[ 0 ] );\r\n			$v( ''#doptv''+ id +''_tx2'' ).val( val[ 1 ] );\r\n		}\r\n	});\r\n/* ]]> */\r\n</script>\r\n<?php } ?>\r\n<!-- SCORN -->\r\n\r\n\r\n\r\n\r\n', 'y', 1495109111, 0, 'y'),
(6, 'Catalog Filter', 'manager/processors/save_content.processor.php', 'after', '', '$key = $modx->db->insert( $dbInsert, $tbl_site_content);', '\r\n		\r\n		\r\n// SCORN\r\n$parentslist= $modx->runSnippet(''GetIdOnLvl'', array(''id''=>$key, ''koren''=>0));\r\nif(is_array($parentslist) && count($parentslist))\r\n	foreach($parentslist AS $row) if($row[''id'']) $qq .= (!empty($qq) ? " OR " : "") ."cf.folders LIKE ''%,{$row[id]},%''";\r\nif($qq) $rs= $modx->db->query("SELECT * FROM ".$modx->getFullTableName(''_catfilter'')." WHERE ({$qq}) AND type!=''price'' AND e=''y'' ORDER BY id");\r\nif($rs && $modx->db->getRecordCount($rs))\r\n{\r\n	while($row= $modx->db->getRow($rs))\r\n	{\r\n		if( ! isset($_POST["doptv".$row[''id''].''_x1_tx''])) continue;\r\n		\r\n		for($kk=1; $kk<=($row[''type'']==''values'' ? 5 : 1); $kk++)\r\n		{\r\n			$doptmplvar= $modx->db->escape(trim($_POST["doptv".$row[''id''].''_x''.$kk.''_tx'']));\r\n			$doptmplvar2= $modx->db->escape(trim($_POST["doptv".$row[''id''].''_x''.$kk.''_tx2'']));\r\n			if($row[''type''] == ''values'')\r\n			{\r\n				if($doptmplvar || $doptmplvar2)\r\n					$modx->db->insert(array(''cf_id''=>$row[''id''], ''itemid''=>$key, ''value''=>$doptmplvar, ''dop''=>$doptmplvar2),\r\n						$modx->getFullTableName(''_catfilter_value''));\r\n			}else{\r\n				$val= $modx->db->select(''id'', $modx->getFullTableName(''_catfilter_value'' ), "cf_id={$row[id]} AND itemid={$key}", "", "1");\r\n				if($val && $modx->db->getRecordCount($val)==1)\r\n				{\r\n					$modx->db->update(array(''value''=>$doptmplvar, ''dop''=>$doptmplvar2), $modx->getFullTableName(''_catfilter_value''),\r\n						"cf_id={$row[id]} AND itemid={$key} LIMIT 1");\r\n				}else{\r\n					$modx->db->insert(array(''cf_id''=>$row[''id''], ''itemid''=>$key, ''value''=>$doptmplvar, ''dop''=>$doptmplvar2),\r\n						$modx->getFullTableName(''_catfilter_value''));\r\n				}\r\n			}\r\n		}\r\n	}\r\n}\r\n// SCORN\r\n\r\n\r\n\r\n', 'y', 1495109111, 0, 'y'),
(7, 'Catalog Filter', 'manager/processors/save_content.processor.php', 'before', '', '		$rs = $modx->db->select(''id, tmplvarid'', $tbl_site_tmplvar_contentvalues, "contentid=''{$id}''");', '\r\n		\r\n		\r\n\r\n// SCORN\r\n$parentslist= $modx->runSnippet(''GetIdOnLvl'', array(''id''=>$id, ''koren''=>0));\r\nif(is_array($parentslist) && count($parentslist))\r\n	foreach($parentslist AS $row) if($row[''id'']) $qq .= (!empty($qq) ? " OR " : "") ."cf.folders LIKE ''%,{$row[id]},%''";\r\nif($qq) $rs= $modx->db->query("SELECT * FROM ".$modx->getFullTableName(''_catfilter'')." WHERE ({$qq}) AND type!=''price'' AND e=''y'' ORDER BY id");\r\nif($rs && $modx->db->getRecordCount($rs))\r\n{\r\n	while($row= $modx->db->getRow($rs))\r\n	{\r\n		$rs2= $modx->db->query("SELECT id, `value`, dop FROM ".$modx->getFullTableName(''_catfilter_value'')."\r\n			WHERE cf_id={$row[id]} AND itemid=''{$id}'' ORDER BY id");\r\n		if($rs2 && $modx->db->getRecordCount($rs2))\r\n		{\r\n			while($row2= $modx->db->getRow($rs2))\r\n			{\r\n				$doptmplvar= $modx->db->escape(trim($_POST["doptv".$row[''id''].''_''.$row2[''id''].''_tx'']));\r\n				$doptmplvar2= $modx->db->escape(trim($_POST["doptv".$row[''id''].''_''.$row2[''id''].''_tx2'']));\r\n				$doptmplvar_del= $_POST["doptv".$row[''id''].''_''.$row2[''id''].''_del''];\r\n				if($doptmplvar_del == ''del'')\r\n				{\r\n					$modx->db->delete($modx->getFullTableName(''_catfilter_value''), "id={$row2[id]} AND cf_id={$row[id]} AND itemid={$id} LIMIT 1");\r\n					continue;\r\n				}\r\n				$modx->db->update(array(''value''=>$doptmplvar, ''dop''=>$doptmplvar2),\r\n					$modx->getFullTableName(''_catfilter_value''), "id={$row2[id]} AND cf_id={$row[id]} AND itemid={$id} LIMIT 1");\r\n			}\r\n		}\r\n		\r\n		if( ! isset($_POST["doptv".$row[''id''].''_x1_tx''])) continue;\r\n		\r\n		for($kk=1; $kk<=($row[''type'']==''values'' ? 5 : 1); $kk++)\r\n		{\r\n			$doptmplvar= $modx->db->escape(trim($_POST["doptv".$row[''id''].''_x''.$kk.''_tx'']));\r\n			$doptmplvar2= $modx->db->escape(trim($_POST["doptv".$row[''id''].''_x''.$kk.''_tx2'']));\r\n			if($row[''type''] == ''values'')\r\n			{\r\n				if($doptmplvar || $doptmplvar2)\r\n					$modx->db->insert(array(''cf_id''=>$row[''id''], ''itemid''=>$id, ''value''=>$doptmplvar, ''dop''=>$doptmplvar2),\r\n						$modx->getFullTableName(''_catfilter_value''));\r\n			}else{\r\n				$val= $modx->db->select(''id'', $modx->getFullTableName(''_catfilter_value'' ), "cf_id={$row[id]} AND itemid={$id}", "", "1");\r\n				if($val && $modx->db->getRecordCount($val)==1)\r\n				{\r\n					$modx->db->update(array(''value''=>$doptmplvar, ''dop''=>$doptmplvar2), $modx->getFullTableName(''_catfilter_value''),\r\n						"cf_id={$row[id]} AND itemid={$id} LIMIT 1");\r\n				}else{\r\n					$modx->db->insert(array(''cf_id''=>$row[''id''], ''itemid''=>$id, ''value''=>$doptmplvar, ''dop''=>$doptmplvar2),\r\n						$modx->getFullTableName(''_catfilter_value''));\r\n				}\r\n			}\r\n		}\r\n	}\r\n}\r\n// SCORN\r\n\r\n\r\n\r\n', 'y', 1495109111, 0, 'y');
